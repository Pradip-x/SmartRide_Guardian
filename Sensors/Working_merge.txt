#include <Wire.h>
#include <TinyGPSPlus.h>
#include <HardwareSerial.h>
#include "MAX30100_PulseOximeter.h"

// ===== Pin Definitions =====
#define EYE_SENSOR_PIN 27
#define SPEAKER_PIN 25
#define MQ135_PIN 34
#define MPU_ADDR 0x68

// ===== Speaker Settings =====
#define CHANNEL 0
#define FREQUENCY 2000
#define RESOLUTION 8

// ===== Objects =====
PulseOximeter pox;
TinyGPSPlus gps;
HardwareSerial GPS(2);

// ===== Eye Blink Variables =====
unsigned long eyeClosedStartTime = 0;
bool eyeBeeping = false;

// ===== MPU6050 Variables =====
int16_t AccX, AccY, AccZ;
float roll;
bool mpuBeeping = false;

// ===== MAX30100 Variables =====
const int SAMPLE_COUNT = 5;
int hrCount = 0;
float hrSum = 0;
float spo2Sum = 0;
unsigned long lastHealthRead = 0;

// ===== GPS Variables =====
unsigned long lastGPSPrint = 0;
unsigned long sameLocationStart = 0;
double lastLat = 0.0;
double lastLng = 0.0;
bool firstFix = true;
bool gpsBeeping = false;

// ===== MQ135 Variables =====
unsigned long lastAirRead = 0;

// ===== I2C Multiplexing =====
bool currentI2CDevice = 0; // 0 = MPU6050, 1 = MAX30100
unsigned long lastI2CSwitch = 0;

void setup() {
  Serial.begin(115200);
  delay(1000);

  // ===== Pin Setup =====
  pinMode(EYE_SENSOR_PIN, INPUT);
  
  // ===== Speaker Setup =====
  ledcAttach(SPEAKER_PIN, FREQUENCY, RESOLUTION);
  ledcWrite(SPEAKER_PIN, 0);

  // ===== I2C Setup =====
  Wire.begin(21, 22);
  Wire.setClock(100000); // Lower speed for stability with multiple devices

  // ===== MPU6050 Init =====
  Wire.beginTransmission(MPU_ADDR);
  Wire.write(0x6B);
  Wire.write(0);
  Wire.endTransmission(true);
  delay(100);

  // ===== MAX30100 Init =====
  if (!pox.begin()) {
    Serial.println("MAX30100 not found - continuing without it");
  } else {
    pox.setIRLedCurrent(MAX30100_LED_CURR_7_6MA);
    Serial.println("MAX30100 ready");
  }

  // ===== GPS Setup =====
  GPS.begin(9600, SERIAL_8N1, 16, 17);

  Serial.println("=== Driver Safety System Started ===");
  Serial.println("Sensors: Eye Blink | MPU6050 | MAX30100 | GPS | MQ-135");
  Serial.println("=====================================\n");
}

void loop() {
  unsigned long currentMillis = millis();

  // ===== Eye Blink Sensor (always check) =====
  checkEyeBlink();

  // ===== I2C Device Switching (every 500ms) =====
  if (currentMillis - lastI2CSwitch >= 500) {
    lastI2CSwitch = currentMillis;
    currentI2CDevice = !currentI2CDevice;

    if (currentI2CDevice == 0) {
      readMPU6050();
    } else {
      readMAX30100();
    }
  }

  // ===== GPS Reading (continuous) =====
  while (GPS.available()) {
    gps.encode(GPS.read());
  }
  
  if (currentMillis - lastGPSPrint >= 7000) {
    lastGPSPrint = currentMillis;
    checkGPS();
  }

  // ===== MQ-135 Air Quality (every 10s) =====
  if (currentMillis - lastAirRead >= 10000) {
    lastAirRead = currentMillis;
    readAirQuality();
  }

  // ===== Speaker Control (priority based) =====
  updateSpeaker();
}

void checkEyeBlink() {
  int sensorState = digitalRead(EYE_SENSOR_PIN);

  if (sensorState == LOW) {
    Serial.println("[EYE] Closed");
    
    if (eyeClosedStartTime == 0) {
      eyeClosedStartTime = millis();
    }

    if (millis() - eyeClosedStartTime >= 10000 && !eyeBeeping) {
      eyeBeeping = true;
      Serial.println("[ALERT] Eyes closed > 10s!");
    }
  } else {
    Serial.println("[EYE] Open");
    eyeClosedStartTime = 0;
    eyeBeeping = false;
  }
}

void readMPU6050() {
  Wire.beginTransmission(MPU_ADDR);
  Wire.write(0x3B);
  Wire.endTransmission(false);
  Wire.requestFrom(MPU_ADDR, 6, true);

  AccX = Wire.read() << 8 | Wire.read();
  AccY = Wire.read() << 8 | Wire.read();
  AccZ = Wire.read() << 8 | Wire.read();

  float Ax = AccX / 16384.0;
  float Ay = AccY / 16384.0;
  float Az = AccZ / 16384.0;

  roll = atan2(Ay, Az) * 180.0 / PI;

  Serial.print("[MPU] Roll: ");
  Serial.print(roll, 2);
  Serial.println(" deg");

  if (roll > 25 || roll < -25) {
    mpuBeeping = true;
    Serial.println("[ALERT] Excessive head tilt!");
  } else {
    mpuBeeping = false;
  }
}

void readMAX30100() {
  pox.update();

  float hr = pox.getHeartRate();
  float spo2 = pox.getSpO2();

  if (hr >= 70 && hr <= 120 && spo2 > 80 && spo2 <= 100) {
    hrSum += hr;
    spo2Sum += spo2;
    hrCount++;
  }

  if (hrCount >= SAMPLE_COUNT) {
    Serial.print("[HEALTH] BPM: ");
    Serial.print(hrSum / SAMPLE_COUNT, 1);
    Serial.print(" | SpO2: ");
    Serial.print(spo2Sum / SAMPLE_COUNT, 1);
    Serial.println("%");

    hrCount = 0;
    hrSum = 0;
    spo2Sum = 0;
  }
}

void checkGPS() {
  if (gps.location.isValid()) {
    double currentLat = gps.location.lat();
    double currentLng = gps.location.lng();

    Serial.print("[GPS] Lat: ");
    Serial.print(currentLat, 6);
    Serial.print(" | Lng: ");
    Serial.println(currentLng, 6);

    if (firstFix) {
      lastLat = currentLat;
      lastLng = currentLng;
      sameLocationStart = millis();
      firstFix = false;
    } else {
      if (currentLat == lastLat && currentLng == lastLng) {
        if (millis() - sameLocationStart >= 60000) {
          gpsBeeping = true;
          Serial.println("[ALERT] Vehicle stationary > 60s!");
        }
      } else {
        lastLat = currentLat;
        lastLng = currentLng;
        sameLocationStart = millis();
        gpsBeeping = false;
      }
    }
  } else {
    Serial.println("[GPS] Waiting for fix...");
  }
}

void readAirQuality() {
  int sensorValue = analogRead(MQ135_PIN);
  String airQuality;

  if (sensorValue < 800)
    airQuality = "Excellent";
  else if (sensorValue < 1300)
    airQuality = "Good";
  else if (sensorValue < 1800)
    airQuality = "Moderate";
  else if (sensorValue < 2300)
    airQuality = "Bad";
  else if (sensorValue < 2800)
    airQuality = "Severe";
  else
    airQuality = "Hazardous";

  Serial.print("[AIR] ADC: ");
  Serial.print(sensorValue);
  Serial.print(" | Quality: ");
  Serial.println(airQuality);
}

void updateSpeaker() {
  // Priority: Eye > MPU > GPS
  if (eyeBeeping || mpuBeeping || gpsBeeping) {
    ledcWrite(SPEAKER_PIN, 200);
  } else {
    ledcWrite(SPEAKER_PIN, 0);
  }
}